#!/bin/bash
#
# SLURM Script for Phase 3 (Reworked): Individual Site Aggregation and Annotation
# This version removes Gene Median calculation and RINT normalization.
#

# === SLURM Directives ===
#SBATCH --job-name=P3_Annot_Matrix
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=4         
#SBATCH --mem=16G                 
#SBATCH --time=04:00:00           
#SBATCH --partition=compute
#SBATCH --output=logs/p3_annot_%j.out
#SBATCH --error=logs/p3_annot_%j.err

set -e -o pipefail

# === Arguments from Wrapper (OUTER array job) ===
INDIVIDUAL_ID=$1

# --- Global Reference Paths ---
GLOBAL_REF_DIR="/path/to/your/reference_data/Annotation"
REDIPortal_BED="${GLOBAL_REF_DIR}/REDIPortal_KnownSites.bed.gz" 
ENSEMBL_GTF="${GLOBAL_REF_DIR}/Homo_sapiens.GRCh38.109.gtf.gz" 

# --- Define Paths ---
PROCESSING_PYTHON_SCRIPT="./Python_scripts/run_phase3_individual_processing_v6.py"

ROOT_PROJECT_OUTPUT_DIR="/scratch/rna_editing_project/output_data" 

INDIVIDUAL_OUTPUT_DIR="${ROOT_PROJECT_OUTPUT_DIR}/${INDIVIDUAL_ID}/P3_Processed_Matrix"
mkdir -p "${INDIVIDUAL_OUTPUT_DIR}"

# Output file now contains raw (unnormalized) Edit Levels
FINAL_OUTPUT_FILE="${INDIVIDUAL_OUTPUT_DIR}/${INDIVIDUAL_ID}_annotated_raw_matrix.tsv"

# --- Parameters ---
MIN_EDIT_LEVEL=0.1 

# Input validation
if [[ -z "$INDIVIDUAL_ID" ]]; then
    echo "ERROR: Missing INDIVIDUAL_ID argument. Exiting."
    exit 1
fi
if [ ! -f "${REDIPortal_BED}" ] || [ ! -f "${ENSEMBL_GTF}" ]; then
    echo "CRITICAL ERROR: Annotation reference files (REDIPortal or Ensembl GTF) not found. Check setup."
    exit 1
fi


echo "Starting Phase 3 Individual Annotation and Matrix Generation for ${INDIVIDUAL_ID}..."

# --- Execution: Call Python Script ---
python3 ${PROCESSING_PYTHON_SCRIPT} \
    --individual_id "${INDIVIDUAL_ID}" \
    --root_search_dir "${ROOT_PROJECT_OUTPUT_DIR}" \
    --output_file "${FINAL_OUTPUT_FILE}" \
    --min_edit_level ${MIN_EDIT_LEVEL} \
    --rediportal_bed "${REDIPortal_BED}" \
    --ensembl_gtf "${ENSEMBL_GTF}"

if [ $? -ne 0 ]; then
    echo "ERROR: Phase 3 Individual Annotation failed."
    exit 1
fi

echo "Phase 3 complete. Annotated matrix (raw Edit Levels) saved to ${FINAL_OUTPUT_FILE}"
