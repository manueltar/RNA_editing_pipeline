#!/bin/bash
#
# SLURM wrapper for Phase 7: edQTL Association Mapping
# This script executes the FastQTL software to perform cis-association testing 
# between genetic variants and normalized RNA editing features.

# --- SLURM Directives ---
# Set the job name
#SBATCH --job-name=edQTL_P7_Mapping
# Set the output file path (%j is the job ID)
#SBATCH --output=logs/phase7_fastqtl_%j.out
# Set the error file path
#SBATCH --error=logs/phase7_fastqtl_%j.err
# Set the partition (adjust this based on your cluster)
#SBATCH --partition=bigmem       # Use a partition suitable for long, compute-intensive jobs
# Reserve sufficient memory
#SBATCH --mem=64G                # Sufficient memory for FastQTL
# Set time limit (adjust as needed)
#SBATCH --time=48:00:00          # Allow up to 48 hours for the analysis
# Set parallelization (adjust based on cluster resources)
#SBATCH --cpus-per-task=16       # Use many cores for maximum parallelization
#SBATCH --nodes=1

# --- Configuration: Paths from Previous Phases ---
# Phenotype matrix (INT-normalized editing ratios from Phase 6)
PHENOTYPE_FILE="./phase6_normalized_edQTL/normalized_edQTL_matrix_p6.tsv"
# Covariate matrix (PCs, PEER, AEI, Cell Proportions from Phase 6)
COVARIATE_FILE="./phase6_normalized_edQTL/covariate_matrix_p6.tsv"

# --- Configuration: Genotype and Output ---
# Assumed location of the VCF file (must be indexed, e.g., using bcftools or tabix)
GENOTYPE_FILE="./genotype_data/genotype_all_individuals.vcf.gz"

# Output directory for results
OUTPUT_DIR="./phase7_edqtl_results"
FINAL_OUTPUT_FILE="${OUTPUT_DIR}/edQTL_mapping_results_p7.tsv.gz"
LOG_FILE="${OUTPUT_DIR}/fastqtl_run_log.txt"

# --- Mapping Parameters ---
# Cis-window size: Standard practice is 1Mb.
CIS_WINDOW_SIZE=1000000
# Number of permutations for nominal P-value calculation
PERMUTATIONS=1000

# --- Setup ---
mkdir -p ${OUTPUT_DIR}
mkdir -p logs

echo "--- Starting Phase 7: edQTL Association Mapping (FastQTL) ---"
echo "Phenotype: ${PHENOTYPE_FILE}"
echo "Genotype: ${GENOTYPE_FILE}"
echo "Output: ${FINAL_OUTPUT_FILE}"
date | tee ${LOG_FILE}

# --- Execution: FastQTL ---
# Command to run FastQTL with permutations for empirical P-value calculation

FastQTL \
    --vcf ${GENOTYPE_FILE} \
    --bed ${PHENOTYPE_FILE} \
    --cov ${COVARIATE_FILE} \
    --output ${FINAL_OUTPUT_FILE} \
    --window ${CIS_WINDOW_SIZE} \
    --permute ${PERMUTATIONS} \
    --threads ${SLURM_CPUS_PER_TASK} \
    --chunk 1 1   # Run all analysis in one chunk (can be split into array jobs if desired)

if [ $? -eq 0 ]; then
    echo "SUCCESS: Phase 7 edQTL Mapping completed." | tee -a ${LOG_FILE}
    echo "Results saved to: ${FINAL_OUTPUT_FILE}" | tee -a ${LOG_FILE}
    # Create success flag for potential future steps (e.g., meta-analysis or fine-mapping)
    touch "${OUTPUT_DIR}/phase7_success.flag"
else
    echo "ERROR: Phase 7 edQTL Mapping failed. Check logs/phase7_fastqtl_${SLURM_JOB_ID}.err" | tee -a ${LOG_FILE}
    exit 1
fi

echo "--- Phase 7 Finished ---"
